import{app as c,BrowserWindow as w,ipcMain as i,dialog as g,session as h,Menu as S,shell as m}from"electron";import r from"node:path";import v from"node:os";import{fileURLToPath as b}from"node:url";import s from"fs";i.handle("save-file",async(o,{filePath:e,blob:n})=>{try{let t=r.dirname(e);if(s.existsSync(t)||s.mkdirSync(t,{recursive:!0}),s.existsSync(e)){let l=r.extname(e),p=r.basename(e,l),d=r.dirname(e),u=new Date().toISOString().replace(/[:.]/g,"-");e=r.join(d,`${p}_${u}${l}`)}return s.writeFileSync(e,Buffer.from(n)),e}catch(t){throw console.error("\u4FDD\u5B58\u6587\u4EF6\u5931\u8D25:",t),t}});i.handle("saveFile",async(o,{filePath:e,blob:n})=>{try{let t=r.dirname(e);if(s.existsSync(t)||s.mkdirSync(t,{recursive:!0}),s.existsSync(e)){let l=r.extname(e),p=r.basename(e,l),d=r.dirname(e),u=new Date().toISOString().replace(/[:.]/g,"-");e=r.join(d,`${p}_${u}${l}`)}return s.writeFileSync(e,Buffer.from(n)),e}catch(t){throw console.error("\u4FDD\u5B58\u6587\u4EF6\u5931\u8D25:",t),t}});i.handle("select-directory",async()=>{let{canceled:o,filePaths:e}=await g.showOpenDialog({properties:["openDirectory"],title:"\u9009\u62E9\u4FDD\u5B58\u8DEF\u5F84"});return{canceled:o,filePaths:e}});i.handle("open-external-link",async(o,e)=>{try{return await m.openExternal(e),!0}catch(n){return console.error("\u65E0\u6CD5\u6253\u5F00\u5916\u90E8\u94FE\u63A5:",n),!1}});i.on("open-external-link",(o,e)=>{m.openExternal(e).catch(n=>{console.error("\u65E0\u6CD5\u6253\u5F00\u5916\u90E8\u94FE\u63A5:",n)}),o.returnValue=!0});i.handle("save-app-config",async(o,e)=>{try{let n=r.join(c.getPath("userData"),"app-config.json");return s.writeFileSync(n,JSON.stringify(e,null,2)),global.appConfig={api:{port:e.apiPort||8080,baseURL:`http://localhost:${e.apiPort||8080}`}},{success:!0}}catch(n){return console.error("\u4FDD\u5B58\u914D\u7F6E\u5931\u8D25:",n),{success:!1,error:n.message}}});i.handle("get-app-config",async()=>{try{return global.appConfig||{api:{port:8080,baseURL:"http://localhost:8080"}}}catch(o){return console.error("\u83B7\u53D6\u914D\u7F6E\u5931\u8D25:",o),{api:{port:8080,baseURL:"http://localhost:8080"}}}});var R=process.platform||v.platform(),f=b(new URL(".",import.meta.url)),a;async function y(){a=new w({icon:r.resolve(f,"icons/icon.png"),width:1e3,height:600,useContentSize:!0,webPreferences:{contextIsolation:!0,preload:r.resolve(f,r.join("preload","electron-preload.cjs"))}}),S.setApplicationMenu(null),c.setName("Moonshine-Image"),h.defaultSession.webRequest.onHeadersReceived((o,e)=>{let n=global.appConfig?.api?.port||8080;e({responseHeaders:{...o.responseHeaders,"Content-Security-Policy":["default-src 'self' data:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self'; connect-src 'self' http://localhost:"+n+" http://127.0.0.1:"+n+" data:; object-src 'none';"]}})}),await a.loadFile("index.html"),a.webContents.on("devtools-opened",()=>{a.webContents.closeDevTools()}),a.on("closed",()=>{a=null})}function x(){try{let o=r.join(c.getPath("userData"),"app-config.json");if(s.existsSync(o)){let e=JSON.parse(s.readFileSync(o,"utf8"));global.appConfig={api:{port:e.apiPort||8080,baseURL:`http://localhost:${e.apiPort||8080}`}}}}catch(o){console.error("\u52A0\u8F7D\u914D\u7F6E\u5931\u8D25:",o)}}c.whenReady().then(()=>{x(),y()});c.on("window-all-closed",()=>{R!=="darwin"&&c.quit()});c.on("activate",()=>{a===null&&y()});
